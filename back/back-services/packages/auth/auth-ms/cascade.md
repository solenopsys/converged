# ТОЧНО! Каждый несёт ответственность за свои ID!

---

## Цепочка ответственности:

```
┌─────────────────────────────────────────────────┐
│  Google (Identity Provider)                     │
│                                                 │
│  Ответственность Google:                        │
│  ✅ Хранит users (Google Account)              │
│  ✅ Аутентифицирует (пароль, 2FA)              │
│  ✅ Выдаёт свои Google User IDs                │
│  ✅ Гарантирует уникальность ID                │
│  ✅ OAuth tokens для доступа к Google API      │
│                                                 │
│  Google User ID: 123456789                      │
└─────────────────────────────────────────────────┘
                    ↓ OAuth
┌─────────────────────────────────────────────────┐
│  4ir.club (твой Authorization Server)           │
│                                                 │
│  Твоя ответственность:                          │
│  ✅ Создаёшь СВОИХ users                       │
│  ✅ Связываешь с Google ID (mapping)           │
│  ✅ Выдаёшь СВОИ user IDs                      │
│  ✅ Гарантируешь уникальность СВОИХ ID         │
│  ✅ OAuth tokens для дочерних приложений       │
│                                                 │
│  Твой User ID: user-uuid-abc                    │
│  Связь: google:123456789 → user-uuid-abc       │
└─────────────────────────────────────────────────┘
                    ↓ OAuth
┌─────────────────────────────────────────────────┐
│  Mobile App (дочернее приложение)               │
│                                                 │
│  Ответственность Mobile App:                    │
│  ✅ Хранит данные пользователя (настройки и тд)│
│  ✅ Привязывает к ТВОЕМУ user_id               │
│  ✅ Использует токены от ТЕБЯ                  │
│                                                 │
│  Знает только: user-uuid-abc                    │
│  (не знает про Google ID!)                      │
└─────────────────────────────────────────────────┘
```

---

## Конкретно:

### **Google несёт ответственность:**
```
✅ Google User ID: 123456789012345
✅ Email: john@gmail.com принадлежит этому ID
✅ Аутентификация john@gmail.com (пароль, 2FA)
✅ Google OAuth tokens действительны
✅ Отзыв доступа если user удалил аккаунт
```

**Ты НЕ отвечаешь:**
- ❌ За безопасность Google аккаунта
- ❌ За правильность Google User ID
- ❌ За то, что john@gmail.com настоящий владелец

**Ты просто доверяешь Google!**

---

### **Ты несёшь ответственность:**
```
✅ Твой User ID: user-uuid-abc
✅ Связь: google:123456789 → user-uuid-abc правильная
✅ Email john@gmail.com в твоей БД актуален
✅ Твои OAuth tokens действительны
✅ Права доступа user-uuid-abc в твоей системе
✅ Authorization codes, refresh tokens валидны
```

**Дочерние приложения НЕ отвечают:**
- ❌ За аутентификацию user-uuid-abc (ты делаешь)
- ❌ За связь с Google (ты делаешь)
- ❌ За валидность токенов (ты проверяешь)

**Они просто доверяют ТЕБЕ!**

---

### **Mobile App несёт ответственность:**
```
✅ За данные user-uuid-abc в своём приложении
✅ За UI/UX для user-uuid-abc
✅ За правильное использование токенов
✅ За refresh токенов когда истекают
```

**Mobile App НЕ отвечает:**
- ❌ За то, кто такой user-uuid-abc (ты сказал — значит так)
- ❌ За аутентификацию (ты уже проверил)
- ❌ За email verification (ты сказал verified — значит так)

---

## Mapping в твоей системе:

```typescript
// Когда Google возвращает user info:
{
  "sub": "123456789012345",      // ← Google User ID (ответственность Google)
  "email": "john@gmail.com",
  "email_verified": true,        // ← Google гарантирует
  "name": "John Doe"
}

// Ты создаёшь СВОЮ запись:
users.put('user-uuid-abc', {
  id: 'user-uuid-abc',            // ← ТВОЙ ID (твоя ответственность)
  email: 'john@gmail.com',        // копия от Google
  name: 'John Doe',
  email_verified: true            // доверяешь Google
});

auth_methods.put('auth:google:123456789012345', {
  user_id: 'user-uuid-abc',       // ← ТВОЯ связь
  provider: 'google',
  provider_user_id: '123456789012345', // ← Google ID
  email: 'john@gmail.com'
});
```

---

## Цепочка доверия (Trust Chain):

```
Mobile App доверяет ТЕБЕ:
  "Если ты сказал user_id=user-uuid-abc, то это John"

ТЫ доверяешь Google:
  "Если Google сказал sub=123456789, то это john@gmail.com"

Google доверяет John:
  "Если John ввёл правильный пароль, это он"
```

**Каждый доверяет предыдущему уровню!**

---

## Что происходит если Google удалил user:

```
1. John удалил Google аккаунт
2. Google revokes все OAuth tokens
3. Ты пытаешься refresh токен → error
4. Ты помечаешь auth_method как invalid:
   
   auth_methods.put('auth:google:123456789', {
     user_id: 'user-uuid-abc',
     provider: 'google',
     provider_user_id: '123456789',
     status: 'revoked'  // ← больше нельзя логиниться через Google
   });

5. НО! user-uuid-abc всё ещё существует у тебя
6. John может залогиниться через GitHub/Email (если есть)
7. Или полностью потерять доступ (если Google был единственный способ)
```

---

## Разделение ответственности:

| Вопрос | Кто отвечает |
|--------|--------------|
| Google User ID валиден? | Google |
| john@gmail.com верифицирован? | Google |
| Пароль john@gmail.com правильный? | Google |
| user-uuid-abc существует? | Ты |
| google:123456789 → user-uuid-abc связь? | Ты |
| user-uuid-abc имеет права admin? | Ты |
| Токен для mobile-app валиден? | Ты |
| user-uuid-abc может видеть проект X? | Mobile App (или Access Service) |

---

## Аналогия с паспортами:

```
Google = страна, выдавшая паспорт
├── Гарантирует: паспорт №123456789 принадлежит John
├── Несёт ответственность за валидность паспорта

Ты = пограничная служба
├── Проверяешь паспорт Google (OAuth)
├── Выдаёшь СВОЮ визу (user-uuid-abc)
├── Несёшь ответственность за правильность визы

Mobile App = отель
├── Проверяет ТВОЮ визу (не паспорт Google!)
├── Доверяет тебе, что виза валидна
```

---

## Итого:

✅ **Google несёт ответственность** за свои User IDs  
✅ **Ты несёшь ответственность** за свои User IDs  
✅ **Mobile App несёт ответственность** за данные пользователя в своём приложении  

✅ **Google не знает про твои IDs**  
✅ **Ты не отвечаешь за Google IDs** (доверяешь)  
✅ **Mobile App не знает про Google IDs** (видит только твои)  

**Каждый владеет своим namespace ID и отвечает только за него!**

---

**Понятна цепочка ответственности?**