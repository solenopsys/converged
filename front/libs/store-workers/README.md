# store-workers

Нужно изучить код, и сделать рефакторинг упросить типы и сделать типы енунмами.
Код поломанный нужно пофиксить просто изучи как реализованы элементы и сделай лучше
buildChunkPlan - нужно переделать так как размер потока не известен этот же алгоритм просто применяется либо к текущему буферу или к остатку, но он не должен давать список а должен давать следущий правильный размер

# Логика работы 

## Upload Worker
- на вход приходит  сообщение c типом UPLOAD_START с указателем на файл
- файл открывается и начинает читаться стримом 
- одновременно идет сжатие потока 
- если стрим закончился или буфер больше 512 кб 
- вычисляется размер чанка 512 килобайт, если меньше то по алгоритму с помощью деления на 2 пока размер не будет меньше 4кб 
- как только нашли размер чанка сразу вырезаем его и отправляем на сохранение через store.service асинхронно.
- на ответ store сервиса висит хендлер который в случае успеха отправляет сообщение CHUNK с хешем владельцу воркера. 
- если произошла ошибка то сервис приходит ({код ошибки и блок байт, номер попытки} для повтора, повтор запускаюется через паузу количество повторов и размер пауз в настройках)
- при том в воркере есть массив промисов который хранит состояние всех чанков и когда поток сжатия дошел до конца идет ожидание завершения всех выгрузок
- в конце запускаем массив промисов через promise all если все воркеры закончились шлем вледельцу сообщение FILE_UPLOADED

## Download Worker 
- на вход приходит сообщение с типом DOWNLOAD_START с массивов хешей и указатель на файл 
- воркер начинает грузить их с первого последовательно
- после получения блоков они сразу попадают в поток декопресси и дальше в поток записи в файл
- в конце последовательной декомпресси владельцу воркера приходит сообщение о том что FILE_DOWNLOADED


## Сборка 
- нужно сделать сборку воркеров в единый скрипт исправить этот ./src/tools/build.ts, просто они будут инициализироваться разными сообщенями 
- нужно создать интеграционный тест где эти воркеры будут подгружатся собранными скриптом и отрабатывать с реальным бекендом 