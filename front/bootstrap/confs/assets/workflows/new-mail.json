{
	"nodes": {
		"start": {
			"type": "StartNode",
			"params": {
				"consts": {
					"footer_raw": "<hr style='margin: 24px 0; border: none; border-top: 1px solid #ccc;'>       <img src='https://mail.4ir.club/logo_{spy}.png' width='80' alt='Индустрия 4.0'><br>        <br>        WhatsApp: +7 (926) 323-50-54"
				}
			}
		},
		"get_object": {
			"type": "SQLQueryNode",
			"params": {
				"query": "SELECT * FROM objects WHERE name = :$.context.start.object_name",
				"provider": "salesProvider"
			}
		},
		"get_template_types": {
			"type": "SQLQueryNode",
			"params": {
				"query": "SELECT * FROM template_type  ",
				"provider": "salesProvider"
			}
		},
		"get_sender": {
			"type": "SQLQueryNode",
			"params": {
				"query": "SELECT * FROM credentials WHERE group_name = :$.context.start.sender_group ORDER BY random() LIMIT 1;",
				"provider": "emailsProvider"
			}
		},
		"select_one_template_by_type": {
			"type": "SQLQueryNode",
			"params": {
				"query": "SELECT id,subject,body FROM templates WHERE template_type = :$.context.ai_select_template_type.template ORDER BY random() LIMIT 1;",
				"provider": "salesProvider"
			}
		},
		"insert_mail": {
			"type": "SQLQueryNode",
			"params": {
				"query": "INSERT INTO mail_draft (  sender, recipient, subject, body,spy,object,template_group,senders_group,template_id )   VALUES (:$.context.get_sender[0].email, :$.context.get_object[0].email, :$.context.templateInjectorSubject, :$.context.convertHtmlN, :$.context.randomStringN.value, :$.context.start.object_name, :$.context.ai_select_template_type.template, :$.context.start.sender_group,:$.context.select_one_template_by_type[0].id) RETURNING id;",
				"provider": "salesProvider"
			}
		},
		"print": {
			"type": "PrintNode"
		},
		"ai_select_template_type": {
			"type": "AiRequest",
			"params": {
				"config": {
					"system": "Ты помощник, который выбирает наиболее подходящий шаблон по контексту. Ответь **только** названием шаблона без пояснений.",
					"user": "Контекст: {{data}} Выбери один шаблон, который наилучшим образом соответствует контексту."
				},
				"provider": "openaiProvider",
				"wrapName": "template"
			}
		},
		"templateInjectorBody": {
			"type": "TemplateInjectorNode",
			"params": {
				"config": {
					"templatePath": "$.context.select_one_template_by_type[0].body",
					"mapping": {
						"recipient_name": "$.context.get_object[0].fio",
						"sender_name": "$.context.get_sender[0].fio",
						"footer": "$.context.templateInjectorFooter"
					}
				}
			}
		},
		"templateInjectorSubject": {
			"type": "TemplateInjectorNode",
			"params": {
				"config": {
					"templatePath": "$.context.select_one_template_by_type[0].subject",
					"mapping": {
						"company_name": "$.context.get_object[0].data.company.name"
					}
				}
			}
		},
		"templateInjectorFooter": {
			"type": "TemplateInjectorNode",
			"params": {
				"config": {
					"templatePath": "$.context.start.footer_raw",
					"mapping": {
						"sender_mail": "$.context.get_sender[0].email",
						"spy": "$.context.randomStringN.value"
					}
				}
			}
		},
		"randomStringN": {
			"type": "RandomStringNode",
			"params": {
				"length": 6
			}
		},
		"convertHtmlN": {
			"type": "MarkNode",
			"params": {
				"templatePath": "$.context.templateInjectorBody",
				"convertToHtml": true
			}
		}
	},
	"connections": {
		"start": ["get_object"],
		"get_object": ["randomStringN"],
		"randomStringN": ["get_sender"],
		"get_sender": ["get_template_types"],
		"get_template_types": ["ai_select_template_type"],
		"ai_select_template_type": ["templateInjectorFooter"],
		"templateInjectorFooter": ["select_one_template_by_type"],

		"select_one_template_by_type": ["templateInjectorBody"],
		"templateInjectorBody": ["templateInjectorSubject"],
		"templateInjectorSubject": ["convertHtmlN"],
		"convertHtmlN": ["insert_mail"],
		"insert_mail": ["print"]
	}
}
