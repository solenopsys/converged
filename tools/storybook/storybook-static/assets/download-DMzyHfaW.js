var u=Uint8Array,S=Uint16Array,dr=Int32Array,or=new u([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ir=new u([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),br=new u([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),tr=function(r,e){for(var a=new S(31),o=0;o<31;++o)a[o]=e+=1<<r[o-1];for(var i=new dr(a[30]),o=1;o<30;++o)for(var b=a[o];b<a[o+1];++b)i[b]=b-a[o]<<5|o;return{b:a,r:i}},fr=tr(or,2),lr=fr.b,gr=fr.r;lr[28]=258,gr[258]=28;var yr=tr(ir,0),Fr=yr.b,J=new S(32768);for(var f=0;f<32768;++f){var k=(f&43690)>>1|(f&21845)<<1;k=(k&52428)>>2|(k&13107)<<2,k=(k&61680)>>4|(k&3855)<<4,J[f]=((k&65280)>>8|(k&255)<<8)>>1}var T=(function(r,e,a){for(var o=r.length,i=0,b=new S(e);i<o;++i)r[i]&&++b[r[i]-1];var h=new S(e);for(i=1;i<e;++i)h[i]=h[i-1]+b[i-1]<<1;var v;if(a){v=new S(1<<e);var l=15-e;for(i=0;i<o;++i)if(r[i])for(var s=i<<4|r[i],c=e-r[i],n=h[r[i]-1]++<<c,t=n|(1<<c)-1;n<=t;++n)v[J[n]>>l]=s}else for(v=new S(o),i=0;i<o;++i)r[i]&&(v[i]=J[h[r[i]-1]++]>>15-r[i]);return v}),B=new u(288);for(var f=0;f<144;++f)B[f]=8;for(var f=144;f<256;++f)B[f]=9;for(var f=256;f<280;++f)B[f]=7;for(var f=280;f<288;++f)B[f]=8;var cr=new u(32);for(var f=0;f<32;++f)cr[f]=5;var mr=T(B,9,1),kr=T(cr,5,1),G=function(r){for(var e=r[0],a=1;a<r.length;++a)r[a]>e&&(e=r[a]);return e},d=function(r,e,a){var o=e/8|0;return(r[o]|r[o+1]<<8)>>(e&7)&a},H=function(r,e){var a=e/8|0;return(r[a]|r[a+1]<<8|r[a+2]<<16)>>(e&7)},Ar=function(r){return(r+7)/8|0},pr=function(r,e,a){return(a==null||a>r.length)&&(a=r.length),new u(r.subarray(e,a))},Sr=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],F=function(r,e,a){var o=new Error(e||Sr[r]);if(o.code=r,Error.captureStackTrace&&Error.captureStackTrace(o,F),!a)throw o;return o},Ur=function(r,e,a,o){var i=r.length,b=0;if(!i||e.f&&!e.l)return a||new u(0);var h=!a,v=h||e.i!=2,l=e.i;h&&(a=new u(i*3));var s=function(rr){var er=a.length;if(rr>er){var ar=new u(Math.max(er*2,rr));ar.set(a),a=ar}},c=e.f||0,n=e.p||0,t=e.b||0,y=e.l,E=e.d,U=e.m,D=e.n,N=i*8;do{if(!y){c=d(r,n,1);var z=d(r,n+1,3);if(n+=3,z)if(z==1)y=mr,E=kr,U=9,D=5;else if(z==2){var _=d(r,n,31)+257,Q=d(r,n+10,15)+4,R=_+d(r,n+5,31)+1;n+=14;for(var x=new u(R),O=new u(19),w=0;w<Q;++w)O[br[w]]=d(r,n+w*3,7);n+=Q*3;for(var X=G(O),vr=(1<<X)-1,sr=T(O,X,1),w=0;w<R;){var Y=sr[d(r,n,vr)];n+=Y&15;var g=Y>>4;if(g<16)x[w++]=g;else{var A=0,P=0;for(g==16?(P=3+d(r,n,3),n+=2,A=x[w-1]):g==17?(P=3+d(r,n,7),n+=3):g==18&&(P=11+d(r,n,127),n+=7);P--;)x[w++]=A}}var Z=x.subarray(0,_),m=x.subarray(_);U=G(Z),D=G(m),y=T(Z,U,1),E=T(m,D,1)}else F(1);else{var g=Ar(n)+4,M=r[g-4]|r[g-3]<<8,I=g+M;if(I>i){l&&F(0);break}v&&s(t+M),a.set(r.subarray(g,I),t),e.b=t+=M,e.p=n=I*8,e.f=c;continue}if(n>N){l&&F(0);break}}v&&s(t+131072);for(var wr=(1<<U)-1,ur=(1<<D)-1,V=n;;V=n){var A=y[H(r,n)&wr],p=A>>4;if(n+=A&15,n>N){l&&F(0);break}if(A||F(2),p<256)a[t++]=p;else if(p==256){V=n,y=null;break}else{var $=p-254;if(p>264){var w=p-257,C=or[w];$=d(r,n,(1<<C)-1)+lr[w],n+=C}var W=E[H(r,n)&ur],q=W>>4;W||F(3),n+=W&15;var m=Fr[q];if(q>3){var C=ir[q];m+=H(r,n)&(1<<C)-1,n+=C}if(n>N){l&&F(0);break}v&&s(t+131072);var j=t+$;if(t<m){var L=b-m,hr=Math.min(m,j);for(L+t<0&&F(3);t<hr;++t)a[t]=o[L+t]}for(;t<j;++t)a[t]=a[t-m]}}e.l=y,e.p=V,e.b=t,e.f=c,y&&(c=1,e.m=U,e.d=E,e.n=D)}while(!c);return t!=a.length&&h?pr(a,0,t):a.subarray(0,t)},Dr=new u(0);function nr(r,e){return Ur(r,{i:2},e,e)}var xr=typeof TextDecoder<"u"&&new TextDecoder,Cr=0;try{xr.decode(Dr,{stream:!0}),Cr=1}catch{}const K=r=>{if(r instanceof Uint8Array)return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer);if(typeof r=="string"){const e=atob(r),a=new Uint8Array(e.length);for(let o=0;o<e.length;o++)a[o]=e.charCodeAt(o);return a}if(typeof r=="object"&&r!==null){const e=r;if(e.__type==="Uint8Array"&&"data"in e)return K(e.data)}throw new Error("StoreService.get returned invalid data")};async function Tr(r,e,a){console.log("[downloadFile] Starting download for:",r);const o=await e.get(r);console.log("[downloadFile] Metadata loaded:",o);const i=await e.getChunks(r);if(console.log("[downloadFile] Chunks loaded:",i.length),i.sort((l,s)=>l.chunkNumber-s.chunkNumber),"showSaveFilePicker"in window)try{const s=await(await window.showSaveFilePicker({suggestedName:o.name,types:o.fileType?[{description:"File",accept:{[o.fileType]:[]}}]:void 0})).createWritable();for(const c of i){console.log("[downloadFile] Processing chunk:",c.chunkNumber);const n=await a.get(c.hash),t=K(n),y=nr(t);await s.write(y)}return await s.close(),console.log("[downloadFile] File written successfully via File System Access API"),{blob:new Blob([]),fileName:o.name}}catch(l){if((l==null?void 0:l.name)==="AbortError")throw new Error("User cancelled download");console.warn("[downloadFile] File System Access API failed, falling back to blob:",l)}console.log("[downloadFile] Using blob fallback");const h=[];for(const l of i){const s=await a.get(l.hash),c=K(s),n=nr(c);h.push(n)}const v=new Blob(h,{type:o.fileType});return console.log("[downloadFile] Blob created:",v.size,"bytes"),{blob:v,fileName:o.name}}export{Tr as downloadFile};
