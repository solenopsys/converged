
–ï—Å–ª–∏ –ø–æ–ª–æ–∂–∏—Ç—å **state –ø–µ—Ä–≤—ã–º —Å–µ–≥–º–µ–Ω—Ç–æ–º**, —Ç–æ:

* `pid/<ROOT>/result/*` ‚Üí –æ–¥–Ω–∏–º range-scan —Å—Ä–∞–∑—É –≤–∏–¥–∏—à—å **–≤—Å–µ –≥–æ—Ç–æ–≤—ã–µ —É–∑–ª—ã**.
* `pid/<ROOT>/start/*` ‚Üí –≤–∏–¥–∏—à—å –≤—Å–µ ¬´–∂–∏–≤—ã–µ –ø–æ–ø—ã—Ç–∫–∏¬ª (–∞–∫—Ç–∏–≤–Ω—ã–µ, –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞).
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏—à—å, –µ—Å—Ç—å –ª–∏ `result/<predId>` —É –ø—Ä–µ–¥–∫–æ–≤.
* –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ¬´workflow –∑–∞–≤–µ—Ä—à—ë–Ω¬ª ‚Üí –µ—Å–ª–∏ –∫–æ–ª-–≤–æ `result/*` == –∫–æ–ª-–≤—É —É–∑–ª–æ–≤ –≤ —Å—Ö–µ–º–µ ‚Üí –∫–æ–Ω–µ—Ü.

---

# üîë –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ (state-first)

```
pid/<ROOT>/meta                  ‚Üí { wf_version, created_at, total_nodes }

pid/<ROOT>/start/<nodeId>/<ts>   ‚Üí { owner, lease }       // –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—É—Å–∫–∞
pid/<ROOT>/result/<nodeId>       ‚Üí { status, data, ts }   // —Ñ–∏–Ω–∞–ª (write-once)

pid/<ROOT>/tombstone?            ‚Üí { reason, ts }         // –¥–ª—è kill/stop
```

---

# ‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä `step(pid)`

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `tombstone` ‚Üí –µ—Å–ª–∏ –µ—Å—Ç—å ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å —Ñ–ª–∞–≥–æ–º kill.
2. –°–∫–∞–Ω–∏—Ä—É–µ—Ç `result/*` ‚Üí –∑–Ω–∞–µ—Ç, –∫–∞–∫–∏–µ —É–∑–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã.
3. –ü–æ —Å—Ö–µ–º–µ (–∏–∑ `meta`) –Ω–∞—Ö–æ–¥–∏—Ç —É–∑–ª—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö **–≤—Å–µ –ø—Ä–µ–¥–∫–∏ –µ—Å—Ç—å –≤ `result/*`** –∏ —Å–∞–º–∏—Ö –µ—â—ë –Ω–µ—Ç –≤ `result/*`.
4. –î–ª—è —Ç–∞–∫–æ–≥–æ —É–∑–ª–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç `start/<id>/<now>` —Å lease.
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ¬´–∑–∞–ø—É—â–µ–Ω —É–∑–µ–ª X¬ª –∏–ª–∏, –µ—Å–ª–∏ `result/*` == `total_nodes`, —Ç–æ ¬´workflow –∑–∞–≤–µ—Ä—à—ë–Ω¬ª.

---

# üìà –ü—Ä–∏–º–µ—Ä

```
pid/42/start/A/1000   ‚Üí {owner=w1}
pid/42/result/A       ‚Üí {status:ok}

pid/42/start/B/1010   ‚Üí {owner=w2}
pid/42/result/B       ‚Üí {status:ok}

pid/42/start/C/1050   ‚Üí {owner=w3}
(–Ω–µ—Ç result/C)
```

* result/A, result/B –µ—Å—Ç—å ‚Üí C —Å—á–∏—Ç–∞–µ—Ç—Å—è –≥–æ—Ç–æ–≤—ã–º (–≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–∫—Ä—ã—Ç—ã).
* –ù–µ—Ç result/C ‚Üí C –µ—â—ë –≤ —Ä–∞–±–æ—Ç–µ.
* –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è result/C ‚Üí —Å—á—ë—Ç—á–∏–∫ result == total\_nodes ‚Üí —Å–∏–≥–Ω–∞–ª ¬´workflow –∑–∞–≤–µ—Ä—à—ë–Ω¬ª.

---

# ‚öñÔ∏è –í—ã–≥–æ–¥—ã state-first

* **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ–±–∑–æ—Ä:** –æ–¥–Ω–∏–º range-scan –ø–æ `result/*` ‚Üí –≤–∏–¥–Ω–æ, —á—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ.
* **–ß–∏—Å—Ç–∞—è –º–æ–¥–µ–ª—å:** `start/*` = –ø–æ–ø—ã—Ç–∫–∏, `result/*` = —Ñ–∞–∫—Ç—ã, –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö ¬´runtime/ready¬ª.
* **–ü—Ä–æ—Å—Ç–æ–µ —É—Å–ª–æ–≤–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è:** `count(result/*) == total_nodes`.

---
